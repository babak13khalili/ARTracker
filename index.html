<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Path Tracker</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family: sans-serif;
      }

      /* نمایش دوربین بدون زوم */
      video {
        position: absolute;
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        background: #000;
      }
      canvas {
        position: absolute;
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        pointer-events: none;
      }

      /* صفحه توضیحات اولیه */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
      }
      #overlay h2 {
        font-weight: 300;
        letter-spacing: 2px;
      }
      #overlay p {
        color: #888;
        max-width: 300px;
        line-height: 1.6;
        font-size: 0.9em;
      }
      #start-btn {
        margin-top: 30px;
        padding: 12px 40px;
        background: transparent;
        color: #fff;
        border: 1px solid #fff;
        cursor: pointer;
        letter-spacing: 1px;
      }

      /* متن راهنما در پایین صفحه */
      #status {
        position: absolute;
        bottom: 40px;
        width: 100%;
        text-align: center;
        color: #fff;
        z-index: 10;
        font-size: 13px;
        font-weight: 300;
        letter-spacing: 1px;
        text-transform: uppercase;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <div id="overlay">
      <h2>AR TRACKER</h2>
      <p>
        Please grant camera access. Point your device at a cup to track its path
        in real-time.
      </p>
      <button id="start-btn">START EXPERIENCE</button>
    </div>

    <div id="status"></div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="output_canvas"></canvas>

    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"
      crossorigin="anonymous"></script>

    <script type="module">
      import {
        ObjectDetector,
        FilesetResolver,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

      const video = document.getElementById("webcam");
      const canvas = document.getElementById("output_canvas");
      const ctx = canvas.getContext("2d");
      const statusDiv = document.getElementById("status");
      const overlay = document.getElementById("overlay");
      const startBtn = document.getElementById("start-btn");

      let objectDetector;
      let objectPath = [];

      startBtn.addEventListener("click", () => {
        overlay.style.display = "none";
        initializeDetector();
      });

      async function initializeDetector() {
        try {
          const vision = await FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm",
          );
          objectDetector = await ObjectDetector.createFromOptions(vision, {
            baseOptions: {
              modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
              delegate: "GPU",
            },
            scoreThreshold: 0.4,
            runningMode: "VIDEO",
          });
          startCamera();
        } catch (error) {
          statusDiv.innerText = "CONNECTION ERROR";
        }
      }

      async function startCamera() {
        try {
          const constraints = { video: { facingMode: "environment" } };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          video.addEventListener("loadeddata", predictWebcam);
        } catch (err) {
          statusDiv.innerText = "CAMERA ACCESS DENIED";
        }
      }

      async function predictWebcam() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const startTimeMs = performance.now();
        if (objectDetector) {
          const detections = await objectDetector.detectForVideo(
            video,
            startTimeMs,
          );
          renderDetections(detections);
        }
        window.requestAnimationFrame(predictWebcam);
      }

      function renderDetections(result) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let detected = false;

        result.detections.forEach((detection) => {
          const label = detection.categories[0].categoryName;

          // تغییر موقت به Cup برای تست
          if (label === "cup") {
            detected = true;
            const { originX, originY, width, height } = detection.boundingBox;
            const posX = originX + width / 2;
            const posY = originY + height;
            objectPath.push({ x: posX, y: posY });
            if (objectPath.length > 150) objectPath.shift();
          }
        });

        statusDiv.innerText = detected ? "TRACKING OBJECT" : "";

        if (objectPath.length > 2) {
          ctx.beginPath();
          ctx.strokeStyle = "#ffffff"; // خط سفید برای تم مینیمال
          ctx.lineWidth = 3;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.moveTo(objectPath[0].x, objectPath[0].y);
          for (let i = 1; i < objectPath.length; i++) {
            ctx.lineTo(objectPath[i].x, objectPath[i].y);
          }
          ctx.stroke();
        }
      }
    </script>
  </body>
</html>
