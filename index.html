<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Bicycle Path Tracker</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
      }
      video {
        position: absolute;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
      }
      canvas {
        position: absolute;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
      }
      #status {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #00ff00;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10;
        font-size: 14px;
        letter-spacing: 0.5px;
        border-left: 4px solid #00ff00;
      }
    </style>
  </head>
  <body>
    <div id="status">Initializing AI Engine...</div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="output_canvas"></canvas>

    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"
      crossorigin="anonymous"></script>

    <script type="module">
      import {
        ObjectDetector,
        FilesetResolver,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

      const video = document.getElementById("webcam");
      const canvas = document.getElementById("output_canvas");
      const ctx = canvas.getContext("2d");
      const statusDiv = document.getElementById("status");

      let objectDetector;
      let bicyclePath = [];

      async function initializeDetector() {
        try {
          const vision = await FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm",
          );
          objectDetector = await ObjectDetector.createFromOptions(vision, {
            baseOptions: {
              modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
              delegate: "GPU",
            },
            scoreThreshold: 0.4,
            runningMode: "VIDEO",
          });
          statusDiv.innerText = "System Ready. Point camera at a bicycle.";
          startCamera();
        } catch (error) {
          statusDiv.innerText = "Error loading models. Check your connection.";
          console.error(error);
        }
      }

      async function startCamera() {
        try {
          const constraints = {
            video: {
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          video.addEventListener("loadeddata", predictWebcam);
        } catch (err) {
          statusDiv.innerText = "Camera access denied.";
        }
      }

      async function predictWebcam() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const startTimeMs = performance.now();
        if (objectDetector) {
          const detections = await objectDetector.detectForVideo(
            video,
            startTimeMs,
          );
          renderDetections(detections);
        }
        window.requestAnimationFrame(predictWebcam);
      }

      function renderDetections(result) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        let detectedBicycle = false;

        result.detections.forEach((detection) => {
          const label = detection.categories[0].categoryName;

          if (label === "bicycle") {
            detectedBicycle = true;
            const { originX, originY, width, height } = detection.boundingBox;

            const posX = originX + width / 2;
            const posY = originY + height;

            bicyclePath.push({ x: posX, y: posY });
            if (bicyclePath.length > 150) bicyclePath.shift();
          }
        });

        if (detectedBicycle) {
          statusDiv.innerText = "Tracking Bicycle...";
          statusDiv.style.color = "#00ff00";
        }

        if (bicyclePath.length > 2) {
          ctx.beginPath();
          ctx.strokeStyle = "#00ff00";
          ctx.lineWidth = 6;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.shadowBlur = 15;
          ctx.shadowColor = "#00ff00";

          ctx.moveTo(bicyclePath[0].x, bicyclePath[0].y);
          for (let i = 1; i < bicyclePath.length; i++) {
            ctx.lineTo(bicyclePath[i].x, bicyclePath[i].y);
          }
          ctx.stroke();
        }
      }

      initializeDetector();
    </script>
  </body>
</html>
