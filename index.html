<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AR Spatial Painter v3</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
      :root {
        --accent: #00ffcc;
      }
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        overflow: hidden;
        font-family: sans-serif;
      }
      .viewport {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }
      video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
      }
      canvas#twod {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 5;
        pointer-events: none;
      }

      #overlay {
        position: absolute;
        inset: 0;
        background: #000;
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
        padding: 20px;
      }

      .top-bar {
        position: absolute;
        top: 20px;
        width: 100%;
        display: none;
        justify-content: center;
        z-index: 30;
      }
      .selector {
        background: rgba(0, 0, 0, 0.7);
        border-radius: 25px;
        padding: 5px;
        display: flex;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
      }
      .sel-btn {
        background: none;
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 10px;
        cursor: pointer;
        opacity: 0.5;
      }
      .sel-btn.active {
        background: var(--accent);
        color: #000;
        opacity: 1;
      }

      .controls {
        position: absolute;
        bottom: 8%;
        width: 100%;
        display: none;
        justify-content: center;
        gap: 20px;
        z-index: 30;
      }
      .circle-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 1px solid #fff;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
      }
      .rec-active {
        color: #ff0055;
        border-color: #ff0055;
        box-shadow: 0 0 15px rgba(255, 0, 85, 0.3);
      }
      .export-mode video {
        opacity: 0.1;
        filter: grayscale(1) brightness(0.5);
      }
    </style>
  </head>
  <body>
    <div class="viewport">
      <div id="overlay">
        <h1 style="font-weight: 100; letter-spacing: 5px">SPATIAL AR</h1>
        <p
          style="
            color: #aaa;
            font-size: 14px;
            max-width: 280px;
            margin-bottom: 30px;
          ">
          Please grant camera access. Point at objects to start painting your
          path in 3D!
        </p>
        <button
          id="start-btn"
          onclick="startProject()"
          style="
            padding: 15px 50px;
            border-radius: 30px;
            border: 1px solid var(--accent);
            background: none;
            color: var(--accent);
            font-size: 16px;
            cursor: pointer;
          ">
          START
        </button>
      </div>

      <div class="top-bar" id="topUI">
        <div class="selector">
          <button class="sel-btn active" onclick="changeTarget('cup', this)">
            CUP
          </button>
          <button class="sel-btn" onclick="changeTarget('person', this)">
            PERSON
          </button>
          <button class="sel-btn" onclick="changeTarget('car', this)">
            CAR
          </button>
          <button class="sel-btn" onclick="changeTarget('bicycle', this)">
            BIKE
          </button>
        </div>
      </div>

      <video id="webcam" autoplay playsinline></video>
      <canvas id="twod"></canvas>

      <div class="controls" id="botUI">
        <button class="circle-btn" onclick="clearLines()">
          <i class="fas fa-undo"></i>
        </button>
        <button id="recBtn" class="circle-btn" onclick="toggleRec()">
          <i class="fas fa-play"></i>
        </button>
        <button id="expBtn" class="circle-btn" onclick="toggleExp()">
          <i class="far fa-circle"></i>
        </button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"
      crossorigin="anonymous"></script>

    <script>
      let detector;
      let objectDetector;
      let video = document.getElementById("webcam");
      let canvas2d = document.getElementById("twod");
      let ctx2d = canvas2d.getContext("2d");
      let scene, camera, renderer;
      let isRecording = false;
      let currentTarget = "cup";
      let objectPaths = {};
      const colors = [
        0x00ffcc, 0xff0055, 0x0077ff, 0xffaa00, 0xcc00ff, 0x00ff00,
      ];

      async function startProject() {
        document.getElementById("start-btn").innerText = "Loading AI...";
        try {
          // Initialize Three.js
          initThree();

          // Initialize MediaPipe Object Detector
          const vision =
            await mediapipe.tasks.vision.FilesetResolver.forVisionTasks(
              "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm",
            );
          objectDetector =
            await mediapipe.tasks.vision.ObjectDetector.createFromOptions(
              vision,
              {
                baseOptions: {
                  modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
                  delegate: "GPU",
                },
                scoreThreshold: 0.3,
                runningMode: "VIDEO",
              },
            );

          // Request Camera
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          video.srcObject = stream;

          document.getElementById("overlay").style.display = "none";
          document.getElementById("topUI").style.display = "flex";
          document.getElementById("botUI").style.display = "flex";

          video.onloadedmetadata = () => {
            canvas2d.width = video.videoWidth;
            canvas2d.height = video.videoHeight;
            animate();
          };
        } catch (err) {
          alert("Error: Camera or AI failed. Ensure you are on HTTPS.");
          console.error(err);
        }
      }

      function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000,
        );
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.querySelector(".viewport").appendChild(renderer.domElement);
        renderer.domElement.style.position = "absolute";
        renderer.domElement.style.top = "0";
        renderer.domElement.style.zIndex = "10";
        renderer.domElement.style.pointerEvents = "none";
        camera.position.z = 5;
      }

      function changeTarget(target, btn) {
        currentTarget = target;
        document
          .querySelectorAll(".sel-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        clearLines();
      }

      function toggleRec() {
        isRecording = !isRecording;
        const btn = document.getElementById("recBtn");
        btn.classList.toggle("rec-active");
        btn.innerHTML = isRecording
          ? '<i class="fas fa-pause"></i>'
          : '<i class="fas fa-play"></i>';
      }

      function clearLines() {
        Object.values(objectPaths).forEach((p) => scene.remove(p.line));
        objectPaths = {};
      }

      function toggleExp() {
        document.body.classList.toggle("export-mode");
        const btn = document.getElementById("expBtn");
        btn.innerHTML = document.body.classList.contains("export-mode")
          ? '<i class="fas fa-circle"></i>'
          : '<i class="far fa-circle"></i>';
      }

      function animate() {
        ctx2d.clearRect(0, 0, canvas2d.width, canvas2d.height);

        if (objectDetector && video.readyState >= 2) {
          const results = objectDetector.detectForVideo(
            video,
            performance.now(),
          );

          results.detections.forEach((det, i) => {
            if (det.categories[0].categoryName === currentTarget) {
              const { originX, originY, width, height } = det.boundingBox;

              // Draw Bounding Box
              ctx2d.strokeStyle = "#00ffcc";
              ctx2d.lineWidth = 2;
              ctx2d.strokeRect(originX, originY, width, height);

              if (isRecording) {
                // Depth Proxy Logic
                const x = ((originX + width / 2) / video.videoWidth) * 10 - 5;
                const y = -((originY + height / 2) / video.videoHeight) * 8 + 4;
                const z = -(width / video.videoWidth) * 10 + 2;

                updatePath(i, x, y, z);
              }
            }
          });
        }

        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }

      function updatePath(id, x, y, z) {
        if (!objectPaths[id]) {
          const color = colors[id % colors.length];
          const geometry = new THREE.BufferGeometry();
          const material = new THREE.LineBasicMaterial({
            color: color,
            linewidth: 5,
          });
          const line = new THREE.Line(geometry, material);
          objectPaths[id] = { line, points: [] };
          scene.add(line);
        }
        const p = objectPaths[id];
        p.points.push(new THREE.Vector3(x, y, z));
        if (p.points.length > 200) p.points.shift();
        p.line.geometry.setFromPoints(p.points);
      }

      window.addEventListener("resize", () => {
        if (camera) {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }
      });
    </script>
  </body>
</html>
