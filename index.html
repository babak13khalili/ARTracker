<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>3D World Tracking Painter</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
      :root {
        --accent: #00ffcc;
        --bg: #000;
      }
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        overflow: hidden;
        font-family: sans-serif;
      }
      .app-container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }
      video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
      }
      canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 3;
        pointer-events: none;
      }
      #overlay {
        position: absolute;
        inset: 0;
        background: var(--bg);
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
        padding: 20px;
      }
      .btn {
        padding: 15px 40px;
        border-radius: 30px;
        border: 1px solid var(--accent);
        background: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div id="overlay">
        <h1 style="font-weight: 100; letter-spacing: 10px">WORLD AR</h1>
        <p>Track objects and walk around them in 3D space.</p>
        <button class="btn" onclick="requestPermissions()">START ENGINE</button>
      </div>
      <video id="webcam" autoplay playsinline></video>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>

    <script type="module">
      import {
        ObjectDetector,
        FilesetResolver,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

      let scene, camera, renderer, detector, testCube;
      let video = document.getElementById("webcam");
      let currentTarget = "cup";
      let isRecording = false;

      // درخواست اجازه دسترسی به سنسورهای حرکتی (مخصوص آیفون)
      window.requestPermissions = async () => {
        if (
          typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function"
        ) {
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === "granted") {
              startExperience();
            }
          } catch (e) {
            alert("Permission denied");
          }
        } else {
          startExperience(); // برای اندروید یا دسکتاپ
        }
      };

      async function startExperience() {
        document.getElementById("overlay").style.display = "none";
        initThree();
        await initDetector();
        setupCamera();
        setupWorldTracking(); // فعال‌سازی سنسورهای حرکتی
      }

      function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000,
        );

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document
          .querySelector(".app-container")
          .appendChild(renderer.domElement);

        // مکعب تست که در محیط ثابت می‌ماند
        const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
        const material = new THREE.MeshNormalMaterial({
          transparent: true,
          opacity: 0.8,
        });
        testCube = new THREE.Mesh(geometry, material);
        scene.add(testCube);

        camera.position.set(0, 0, 0);
      }

      // بخش جدید: چرخاندن دوربین همگام با چرخش گوشی (World Tracking پایه)
      function setupWorldTracking() {
        window.addEventListener("deviceorientation", (event) => {
          const alpha = event.alpha ? THREE.MathUtils.degToRad(event.alpha) : 0; // چرخش حول محور Z
          const beta = event.beta ? THREE.MathUtils.degToRad(event.beta) : 0; // چرخش حول محور X
          const gamma = event.gamma ? THREE.MathUtils.degToRad(event.gamma) : 0; // چرخش حول محور Y

          // تنظیم جهت دوربین بر اساس سنسور ژیروسکوپ
          camera.rotation.set(beta, alpha, -gamma, "YXZ");
        });
      }

      async function initDetector() {
        const vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm",
        );
        detector = await ObjectDetector.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
            delegate: "GPU",
          },
          scoreThreshold: 0.35,
          runningMode: "VIDEO",
        });
      }

      async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
        });
        video.srcObject = stream;
        video.onloadedmetadata = renderLoop;
      }

      function renderLoop() {
        if (detector && video.readyState >= 2) {
          const results = detector.detectForVideo(video, performance.now());

          results.detections.forEach((det) => {
            if (det.categories[0].categoryName === currentTarget) {
              const { originX, originY, width } = det.boundingBox;

              // تبدیل مختصات تصویر به مختصات جهانی (World Space)
              const nx = ((originX + width / 2) / video.videoWidth) * 2 - 1;
              const ny = -(
                ((originY +
                  det.boundingBox.originY +
                  det.boundingBox.height / 2) /
                  video.videoHeight) *
                  2 -
                1
              );
              const dist = (video.videoWidth / width) * 0.5;

              // قرار دادن آبجکت در نقطه‌ای که دوربین به آن نگاه می‌کند
              const vector = new THREE.Vector3(nx, ny, -1);
              vector.unproject(camera);
              const dir = vector.sub(camera.position).normalize();
              const targetPos = camera.position
                .clone()
                .add(dir.multiplyScalar(dist));

              testCube.position.copy(targetPos);

              // رسم مسیر (همیشه در فضا باقی می‌ماند)
              if (true) {
                // در این نسخه همیشه رسم می‌کند برای تست
                const trailGeom = new THREE.SphereGeometry(0.05, 8, 8);
                const trailMat = new THREE.MeshBasicMaterial({
                  color: 0x00ffcc,
                });
                const dot = new THREE.Mesh(trailGeom, trailMat);
                dot.position.copy(targetPos);
                scene.add(dot);
              }
            }
          });
        }
        renderer.render(scene, camera);
        requestAnimationFrame(renderLoop);
      }
    </script>
  </body>
</html>
